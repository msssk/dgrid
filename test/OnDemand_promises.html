<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Test OnDemandGrids with promise-based stores</title>
		<link rel="stylesheet" href="../../dojo/resources/dojo.css">
		<link rel="stylesheet" href="../css/skins/claro.css">
		<style>
			.dgrid {
				height: 300px;
			}
		</style>
	</head>

	<body class="claro">
		<p>This test page tests stores that return promises from their query methods.</p>

		<h2>Grid with a dstore/Store</h2>
		<div>
			<button onclick="grid.set('collection', grid.collection.filter({ name: 'foo' }))">Show only items named 'foo'</button>
			<button onclick="grid.set('collection', asyncStore)">Reset query</button>
		</div>

		<div id="grid1"></div>

		<h2>Grid with a dojo/store</h2>
		<div id="grid2"></div>

		<h2>Grid with a dojo/data store</h2>
		<div id="grid3"></div>


<script src="../../dojo/dojo.js" data-dojo-config="async: true"></script>

<script>
var grid;
var asyncStore;

require([
	"dojo/_base/declare",
	"dojo/_base/lang",
	"dojo/Deferred",
	"dojo/data/ItemFileReadStore",
	"dojo/store/DataStore",
	"dojo/store/Memory",
	"dojo/store/util/QueryResults",
	"dgrid/OnDemandGrid",
	"dgrid/test/data/createAsyncStore",
	"dstore/legacy/StoreAdapter",
	"dstore/Observable",
	"dgrid/test/data/stateData"
], function (declare, lang, Deferred, ItemFileReadStore, DataStore, LegacyMemory, QueryResults, OnDemandGrid,
	createAsyncStore, StoreAdapter, Observable, stateData) {

	var dataStore;
	var names = ["sasquatch", "foo", "bar", "zaphod", "beeblebrox"];

	function createItems(){
		// generate data
		var items = [];
		var i;
		for(i = 1; i <= 200; i++){
			items.push({
				id: i,
				name: names[i % 5]
			});
		}
		return items;
	}

	asyncStore = createAsyncStore({ data: createItems() });

	// Create a grid with an async dstore store
	grid = new OnDemandGrid({
		columns: { id: "id", name: "name" },
		collection: asyncStore
	}, "grid1");

	// Create a grid with an async dojo/store store
	var LegacyAsyncMemory = declare([LegacyMemory], {
		query: function(query, options){
			var results, def, timer;
			results = this.inherited(arguments);
			def = new Deferred(function(){
				clearTimeout(timer);
			});
			timer = setTimeout(function(){
				def.resolve(results);
			}, 200);
			return QueryResults(def.promise);
		}
	});

	var store = new StoreAdapter({
		objectStore: new LegacyAsyncMemory({
			data: createItems()
		})
	});

	new OnDemandGrid({
		columns: { id: "id", name: "name" },
		collection: store
	}, "grid2");

	// Create a dojo/data store instance and use the dojo/store/DataStore adapter
	dataStore = new DataStore({
		store: new ItemFileReadStore({
			data: stateData
		})
	});

	// Create a grid using dstore/legacy/StoreAdapter on dataStore
	new OnDemandGrid({
		columns: { name: "Name", abbreviation: "Abbreviation" },
		collection: new StoreAdapter({ objectStore: dataStore })
	}, "grid3");
});
</script>

</body>
</html>
