<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>faux scroller POC</title>
		<style>
			* {
				box-sizing: border-box;
			}

			body {
				font-family: sans-serif;
			}

			#container {
				border: 1px solid rgb(53, 54, 53);
				height: 500px;
				width: 800px;
				overflow: hidden;
				position: relative;
				margin: 30px;
			}

			#viewport {
				height: 100%;
				overflow: hidden;
			}

			#content {
				height: 100%;
				overflow-y: scroll;
			}

			#scroller {
				height: 100%;
				overflow-x: hidden;
				overflow-y: scroll;
				position: absolute;
				right: 0;
				top: 0;
			}

			.row {
				border-top: 1px solid rgb(53, 54, 53);
				padding: 12px;
				width: 100%;
			}

			.row:first-of-type {
				border-top: none;
			}
		</style>
	</head>

	<body>
		<div id="container">
			<div id="viewport">
				<div id="content">
				</div>
			</div>
			<div id="scroller">
				<div id="scrollerContent"></div>
			</div>
		</div>

		<button id="disableButton">Disable</button>
		<button id="enableButton">Enable</button>

		<p>Scroll handling is enabled by default.</p>

		<p>Testing:
			<ul>
				<li>Test scrolling with mousewheel in the content area</li>
				<li>Test direct interactions with the right-most scrollbar - the left one can be ignored since
					in practice it will always be hidden.
				</li>
			</ul>
		</p>

		<p>Problems:
			<ol>
				<li>Drag the scroll handle up and down, play with it a bit. It's mostly reliable,
					but occasionally when you release it and stop scrolling, the left scroller is not in sync.
					<ul>
						<li>This should <em>never</em> happen. Very bad UX.</li>
					</ul>
				</li>
				<li>Click the up/down buttons at the top and bottom of the scroll bar. Scrolling is a bit janky.
					<ul>
						<li>For comparison, click the "Disable" button to disable all scroll handling, then use the
							up/down buttons on the left scroll bar.</li>
					</ul>
				</li>
				<li>Use mouse wheel to scroll down a bit (10-15% of the scroll height should suffice). Rapidly scroll
					back up. Sometimes the content will scroll to the top, but the right scroll bar handle will not
					be all the way at the top.
				</li>
			</ol>
		</p>

		<p>Hopefully some of these issues are related to the <code>throttle</code> function in use. However, the
			<code>throttle</code> function has been designed to not discard the final invocation.
		</p>

		<script src="../../dojo/dojo.js" data-dojo-config="async: true"></script>

		<script>
			require([
				'dojo/dom',
				'dojo/on'
			], function(dom, on) {
				var container = dom.byId('container');
				var viewport = dom.byId('viewport');
				var content = dom.byId('content');
				var scroller = dom.byId('scroller');
				var scrollerContent = dom.byId('scrollerContent');
				// TODO: do something about OSX
				// http://stackoverflow.com/questions/7492062/css-overflow-scroll-always-show-vertical-scroll-bar
				// If calculated scrollbarWidth is 0, then can we assume it is 7px?
				// IE will not make the scrollbar scrollable if no content is visible, so make 1px of it visible
				// maybe low opacity?
				var scrollbarWidth = content.offsetWidth - content.clientWidth + 1;
				var row;
				var i;

				// hide the content's scrollbar
				/* */
				viewport.style.width = (container.clientWidth - scrollbarWidth) + 'px';
				content.style.width = container.clientWidth + 'px';
				scroller.style.width = scrollbarWidth + 'px';
				/* */

				// make both scrollbars visible for testing
				/* * /
				viewport.style.width = (container.clientWidth - scrollbarWidth - 1) + 'px';
				content.style.width = (container.clientWidth - (scrollbarWidth + 1) - 1) + 'px';
				scroller.style.width = (scrollbarWidth + 1) + 'px';
				/* */

				for (i = 0; i < 500; i++) {
					row = document.createElement('div');
					row.className = 'row';
					row.innerHTML = 'Row ' + (i + 1);
					content.appendChild(row);
				}

				scrollerContent.style.height = content.scrollHeight + 'px';


				var handleContentScroll;
				var handleScrollerScroll;
				var contentScrollHandle;
				var scrollerScrollHandle;
				var contentScrollPauseCounter = 0;
				var scrollerScrollPauseCounter = 0;
				var waiting = false;

				function handleContentScroll(event) {
					if (contentScrollPauseCounter) {
						contentScrollPauseCounter--;
						return;
					}

					scrollerScrollPauseCounter++;
					scroller.scrollTop = event.target.scrollTop;
				}

				function handleScrollerScroll(event) {
					if (scrollerScrollPauseCounter) {
						scrollerScrollPauseCounter--;
						return;
					}

					contentScrollPauseCounter++;
					content.scrollTop = event.target.scrollTop;
				}

				contentScrollHandle = on(content, 'scroll', handleContentScroll);
				scrollerScrollHandle = on(scroller, 'scroll', handleScrollerScroll);


				on(dom.byId('disableButton'), 'click', function() {
					contentScrollHandle.remove();
					scrollerScrollHandle.remove();
				});

				on(dom.byId('enableButton'), 'click', function() {
					contentScrollHandle = on(content, 'scroll', handleContentScroll);
					scrollerScrollHandle = on(scroller, 'scroll', handleScrollerScroll);
				});
			});
		</script>
	</body>
</html>
