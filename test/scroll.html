<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>faux scroller POC</title>
		<style>
			* {
				box-sizing: border-box;
			}

			body {
				background-color: rgb(34, 45, 54);
				color: rgb(145, 161, 175);
				font-family: sans-serif;
			}

			#container {
				border: 1px solid rgb(74, 91, 122);
				height: 500px;
				width: 800px;
				overflow: hidden;
				position: relative;
				margin: 30px;
			}

			#viewport {
				height: 100%;
				overflow: hidden;
			}

			#content {
				height: 100%;
				overflow-y: scroll;
			}

			#scroller {
				height: 100%;
				overflow-x: hidden;
				overflow-y: scroll;
				position: absolute;
				right: 0;
				top: 0;
			}

			.row {
				border-top: 1px solid rgb(53, 54, 53);
				padding: 12px;
				width: 100%;
			}

			.even {
				background-color: rgb(47, 79, 107);
			}

			.row:first-of-type {
				border-top: none;
			}
		</style>
	</head>

	<body>
		<h1>Virtualized scrollbar proof-of-concept</h1>

		<p>
			This demonstrates the viability of virtualized scrolling, wherein the scrollbar is not directly attached
			to the content being scrolled.
		</p>

		<ul>
			<li>The content scrollbar is obscured by a separate element with a scrollbar</li>
			<li>Scroll event listeners on both elements keep the scroll position synchronized between the two</li>
		</ul>

		<div id="container">
			<div id="viewport">
				<div id="content">
				</div>
			</div>
			<div id="scroller">
				<div id="scrollerContent"></div>
			</div>
		</div>

		<form id="configForm">
			<div>
				Scroll synchronization:
				<label><input type="radio" name="scrollsync" value="enabled" checked>Enabled</label>
				<label><input type="radio" name="scrollsync" value="disabled">Disabled</label>
			</div>
			<div>
				Content area scrollbar (show for debugging)
				<label><input type="radio" name="debugscrollbar" value="hide" checked>Hide</label>
				<label><input type="radio" name="debugscrollbar" value="show">Show</label>
			</div>
		</form>

		<p>
			Test both with scroll synchronization enabled and disabled. When enabled, performance and responsiveness
			should closely match when disabled.
			<ul>
				<li>Scroll with mousewheel in the content area</li>
				<li>Scroll by dragging the scroll handle</li>
				<li>Scroll with the mousewheel while the cursor is positioned over the scrollbar</li>
				<li>Scroll by clicking and holding the up and down arrows at the top and bottom of the scrollbar</li>
				<li>Scroll by clicking and holding the cursor on the scrollbar, but outside the scroll handle</li>
			</ul>
		</p>

		<p>
			Early iterations of this proof-of-concept involved <code>requestAnimationFrame</code> and throttling or
			debouncing the scroll event handler. The best performance achieved was without any optimization efforts.
		</p>

		<script>
			(function () {
				var container = document.getElementById('container');
				var viewport = document.getElementById('viewport');
				var content = document.getElementById('content');
				var scroller = document.getElementById('scroller');
				var scrollerContent = document.getElementById('scrollerContent');
				var fragment = document.createDocumentFragment();
				// TODO: do something about OSX
				// http://stackoverflow.com/questions/7492062/css-overflow-scroll-always-show-vertical-scroll-bar
				// If calculated scrollbarWidth is 0, then can we assume it is 7px?
				// IE will not make the scrollbar scrollable if no content is visible, so make 1px of it visible
				// maybe low opacity?
				var scrollbarWidth = content.offsetWidth - content.clientWidth + 1;
				var row;
				var i;

				function hideContentScrollbar () {
					viewport.style.width = (container.clientWidth - scrollbarWidth) + 'px';
					content.style.width = container.clientWidth + 'px';
					scroller.style.width = scrollbarWidth + 'px';
				}

				function showContentScrollbar () {
					viewport.style.width = (container.clientWidth - scrollbarWidth - 1) + 'px';
					content.style.width = (container.clientWidth - (scrollbarWidth + 1) - 1) + 'px';
					scroller.style.width = (scrollbarWidth + 1) + 'px';
				}

				hideContentScrollbar();

				for (i = 0; i < 500; i++) {
					row = document.createElement('div');
					row.className = 'row' + ((i % 2) ? ' even' : '');
					row.innerHTML = 'Row ' + (i + 1);
					fragment.appendChild(row);
				}
				content.appendChild(fragment);

				scrollerContent.style.height = content.scrollHeight + 'px';

				var contentScrollPauseCounter = 0;
				var scrollerScrollPauseCounter = 0;

				function handleContentScroll (event) {
					if (contentScrollPauseCounter) {
						contentScrollPauseCounter--;
						return;
					}

					scrollerScrollPauseCounter++;
					scroller.scrollTop = event.target.scrollTop;
				}

				function handleScrollerScroll (event) {
					if (scrollerScrollPauseCounter) {
						scrollerScrollPauseCounter--;
						return;
					}

					contentScrollPauseCounter++;
					content.scrollTop = event.target.scrollTop;
				}

				function deferredContentScrollHandler (event) {
					setTimeout(handleContentScroll, 0, event);
				}

				function enableScrollSync () {
					content.addEventListener('scroll', handleContentScroll);
					// content.addEventListener('scroll', deferredContentScrollHandler);
					scroller.addEventListener('scroll', handleScrollerScroll);
				}

				function disableScrollSync () {
					content.removeEventListener('scroll', handleContentScroll);
					scroller.removeEventListener('scroll', handleScrollerScroll);
				}

				document.getElementById('configForm').addEventListener('change', function (event) {
					if (event.target.name === 'scrollsync') {
						if (event.target.value === 'enabled') {
							enableScrollSync();
						}
						else {
							disableScrollSync();
						}
					}
					else if (event.target.name === 'debugscrollbar') {
						if (event.target.value === 'show') {
							showContentScrollbar();
						}
						else {
							hideContentScrollbar();
						}
					}
				})

				enableScrollSync();
			})();
		</script>
	</body>
</html>
